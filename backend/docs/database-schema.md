# J's Money Backend - Database Schema

## ì „ì²´ ê°œìš”

J's MoneyëŠ” ê°œì¸ ìì‚°ê´€ë¦¬ë¥¼ ìœ„í•œ ì¢…í•© í”Œë«í¼ìœ¼ë¡œ, PostgreSQLê³¼ Redisë¥¼ í™œìš©í•œ í•˜ì´ë¸Œë¦¬ë“œ ì•„í‚¤í…ì²˜ë¥¼ ì±„íƒí•©ë‹ˆë‹¤.

### ë„ë©”ì¸ ë²”ìœ„
- **ì‚¬ìš©ì ê´€ë¦¬**: ì¸ì¦ ë° í”„ë¡œí•„
- **ê³„ì¢Œ ê´€ë¦¬**: ì€í–‰/ì¦ê¶Œ/ê°€ìƒí™”í ê³„ì¢Œ
- **ìì‚° ì¶”ì **: ì£¼ì‹, ê°€ìƒí™”í, ì±„ê¶Œ, í€ë“œ, ETF, í˜„ê¸ˆ
- **ê±°ë˜ ê¸°ë¡**: ë§¤ë§¤, ë°°ë‹¹, ì´ì²´, ì¡°ì •
- **ì‹¤ì‹œê°„ ë°ì´í„°**: Redis ê¸°ë°˜ ì”ê³  ë° ì‹œì„¸ ê´€ë¦¬

### í•µì‹¬ ì„¤ê³„ ì›ì¹™
1. **ìì‚° ì¤‘ì‹¬ ì•„í‚¤í…ì²˜**: ëª¨ë“  ê±°ë˜ëŠ” ìì‚°(`assets`) ì¤‘ì‹¬ìœ¼ë¡œ ê¸°ë¡
2. **ë³µì‹ë¶€ê¸° ì›ì¹™**: ìì‚° êµí™˜ì€ 2ê°œ ë ˆì½”ë“œë¡œ ì •í™•í•œ ê°ì‚¬ ì¶”ì 
3. **ìˆ˜ëŸ‰ ë³€í™” ì¤‘ì‹¬**: ê±°ë˜ì˜ ë³¸ì§ˆì€ ìì‚° ìˆ˜ëŸ‰ì˜ ì¦ê°
4. **Redis í•˜ì´ë¸Œë¦¬ë“œ**: PostgreSQL(ê±°ë˜ ì´ë ¥) + Redis(ì‹¤ì‹œê°„ ì”ê³ /ì‹œì„¸)
5. **íƒ€ì… ì•ˆì „ì„±**: Enumìœ¼ë¡œ ê³ ì • ë„ë©”ì¸ ê´€ë¦¬, ì»´íŒŒì¼íƒ€ì„ ê²€ì¦

### ì•„í‚¤í…ì²˜ ê°œìš”

```
ë°ì´í„° ì €ì¥ ì „ëµ:
- PostgreSQL: ê±°ë˜ ì´ë ¥, ì‚¬ìš©ì/ê³„ì¢Œ ì •ë³´ (ACID ë³´ì¥)
- Redis: ì‹¤ì‹œê°„ ìì‚° ì”ê³ , í˜„ì¬ê°€ (ë¹ ë¥¸ ì¡°íšŒ/ì—…ë°ì´íŠ¸)

ë°ì´í„° íë¦„:
ì‚¬ìš©ì â†’ ê³„ì¢Œ â†’ ìì‚° â†’ ê±°ë˜
  â†“       â†“      â†“      â†“
 DB     DB     DB   DB+Redis
```

## ë¬¸ì„œ êµ¬ì¡°

### ï¿½ ìƒì„¸ ë¬¸ì„œ

ê° ì˜ì—­ë³„ ìƒì„¸ ë¬¸ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì´ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤:

- **[PostgreSQL ìŠ¤í‚¤ë§ˆ](./postgresql-schema.md)**: í…Œì´ë¸” ì •ì˜, ì œì•½ì¡°ê±´, ì¸ë±ìŠ¤
- **[Redis êµ¬ì¡°](./redis-schema.md)**: ì‹¤ì‹œê°„ ë°ì´í„°, ìˆ˜ìµ ê³„ì‚° í, ìºì‹œ ì „ëµ  
- **[ê±°ë˜ ì˜ˆì œ](./transaction-examples.md)**: ì‹¤ì œ ë¹„ì¦ˆë‹ˆìŠ¤ ì¼€ì´ìŠ¤ë³„ ê±°ë˜ ì²˜ë¦¬ ë°©ë²•
- **[ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ](./migration-guide.md)**: ë°°í¬, ì„¤ì •, ë°±ì—…, ë¬¸ì œí•´ê²°

## ë¹ ë¥¸ ì°¸ì¡°

### í•µì‹¬ í…Œì´ë¸” ê´€ê³„
```
users (ì‚¬ìš©ì)
  â†“ 1:N
accounts (ê³„ì¢Œ)
  â†“ 1:N
assets (ìì‚°)
  â†“ 1:N
transactions (ê±°ë˜)
```

### ì£¼ìš” Enum íƒ€ì…
- **AccountType**: bank_account, securities, cash, crypto_wallet ë“±
- **AssetType**: stock, crypto, bond, fund, etf, cash, savings, deposit
- **TransactionType**: buy, sell, deposit, withdraw, dividend, interest, fee, transfer_in, transfer_out, adjustment, invest, redeem, internal_transfer, card_payment, promotion_deposit, auto_transfer, remittance, exchange, out_asset, in_asset

### ë³´ì¡° ì‹œìŠ¤í…œ
- **account_shares**: ê³„ì¢Œ ê³µìœ  ë° ê¶Œí•œ ê´€ë¦¬
- **tags/taggables**: ìì‚°/ê³„ì¢Œ/ê±°ë˜ íƒœê·¸ ì‹œìŠ¤í…œ
- **reminders**: ê²€í†  ì•Œë¦¼, ë°°ë‹¹ì¼ ì•Œë¦¼ ë“±
- **activities**: ëŒ“ê¸€ ë° ì‹œìŠ¤í…œ ë¡œê·¸ (ë¶ˆë³€ì„± ì§€ì›)
- **categories**: ê±°ë˜ ë¶„ë¥˜ (ì§€ì¶œ/ìˆ˜ì…/íˆ¬ì/ì´ë™/ì¤‘ë¦½)
- **category_auto_rules**: ê±°ë˜ ìë™ ë¶„ë¥˜ ê·œì¹™

## ë°ì´í„° ì„¤ê³„ ì›ì¹™

### 1. ìì‚° ì¤‘ì‹¬ ì•„í‚¤í…ì²˜
ëª¨ë“  ê±°ë˜ëŠ” ìì‚°(`assets`)ì„ ì¤‘ì‹¬ìœ¼ë¡œ ê¸°ë¡ë©ë‹ˆë‹¤. ê³„ì¢ŒëŠ” ìì‚°ì˜ ì»¨í…Œì´ë„ˆ ì—­í• ë§Œ ìˆ˜í–‰í•©ë‹ˆë‹¤.

```
ì˜ˆì‹œ: ì£¼ì‹ ë§¤ìˆ˜
1. í˜„ê¸ˆ ìì‚° ê°ì†Œ (transactions ë ˆì½”ë“œ)
2. ì£¼ì‹ ìì‚° ì¦ê°€ (transactions ë ˆì½”ë“œ)
â†’ related_transaction_idë¡œ ì—°ê²°
```

### 2. ë³µì‹ë¶€ê¸° ì›ì¹™
ìì‚° êµí™˜ ê±°ë˜ëŠ” ë°˜ë“œì‹œ 2ê°œì˜ ë ˆì½”ë“œë¡œ ê¸°ë¡ë˜ì–´ ê°ì‚¬ ì¶”ì ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

### 3. ìˆ˜ëŸ‰ ë³€í™” ì¤‘ì‹¬
ê±°ë˜ì˜ ë³¸ì§ˆì€ ìì‚° ìˆ˜ëŸ‰ì˜ ì¦ê°ì…ë‹ˆë‹¤:
- `quantity > 0`: ìì‚° ì¦ê°€
- `quantity < 0`: ìì‚° ê°ì†Œ
- `quantity = 0`: ë§ˆì»¤ (ì˜ˆ: ë°°ë‹¹ ê¸°ë¡ìš©)

ì¶”ê°€ë¡œ `transaction_metadata` JSONB í•„ë“œë¥¼ í†µí•´ ê±°ë˜ë³„ ìƒì„¸ ì •ë³´(í™˜ìœ¨, ì™¸ë¶€ ID ë“±)ë¥¼ ìœ ì—°í•˜ê²Œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 4. ì‹¤ì‹œê°„ ë°ì´í„° í•˜ì´ë¸Œë¦¬ë“œ
- **PostgreSQL**: ëª¨ë“  ê±°ë˜ ì´ë ¥ (ACID ë³´ì¥)
- **Redis**: ì‹¤ì‹œê°„ ìì‚° ì”ê³ , í˜„ì¬ê°€ ìºì‹œ

### 5. Polymorphic íŒ¨í„´
íƒœê·¸, ì•Œë¦¼, í™œë™ ì‹œìŠ¤í…œì€ Polymorphic íŒ¨í„´ìœ¼ë¡œ ëª¨ë“  ì—”í‹°í‹°ì— ì ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.

## ë¬¸ì„œ êµ¬ì¡°

### ğŸ“š ìƒì„¸ ë¬¸ì„œ

ê° ì˜ì—­ë³„ ìƒì„¸ ë¬¸ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì´ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤:

- **[PostgreSQL ìŠ¤í‚¤ë§ˆ](./postgresql-schema.md)**: í…Œì´ë¸” ì •ì˜, ì œì•½ì¡°ê±´, ì¸ë±ìŠ¤, ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™
- **[Redis êµ¬ì¡°](./redis-schema.md)**: ì‹¤ì‹œê°„ ë°ì´í„°, ìˆ˜ìµ ê³„ì‚° í, ìºì‹œ ì „ëµ  
- **[API ê°€ì´ë“œ](./api-guide.md)**: RESTful API ì‚¬ìš©ë²•, ì¸ì¦, ì—”ë“œí¬ì¸íŠ¸ ì„¤ëª…
- **[ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ](./migration-guide.md)**: ë°°í¬, ì„¤ì •, ë°±ì—…, ë¬¸ì œí•´ê²°

## ë¹ ë¥¸ ì°¸ì¡°
accounts (ê³„ì¢Œ)
  â†“ 1:N  
assets (ìì‚°)
  â†“ 1:N
transactions (ê±°ë˜)
```

### Redis í‚¤ ìš”ì•½
```
# ì‹¤ì‹œê°„ ìì‚° ì •ë³´
asset:{asset_id}:quantity        â†’ ë³´ìœ  ìˆ˜ëŸ‰
asset:{asset_id}:avg_price       â†’ í‰ê·  ë§¤ìˆ˜ê°€  
asset:{asset_id}:current_price   â†’ í˜„ì¬ê°€ (ì™¸ë¶€ API)
asset:{asset_id}:purchase_queue  â†’ ë§¤ìˆ˜ ë‚´ì—­ [[ìˆ˜ëŸ‰,ì·¨ë“ì›ê°€], ...]
```

### ì£¼ìš” ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™
- **ë³µì‹ë¶€ê¸°**: ìì‚° êµí™˜ì€ 2ê°œ ê±°ë˜ë¡œ ê¸°ë¡
- **ìˆ˜ìµ ê³„ì‚°**: ì‚¬ìš©ìë³„ FIFO/LIFO/AVG ë°©ì‹ ì„ íƒ
- **ë°°ë‹¹ ì²˜ë¦¬**: ì£¼ì‹ì¸¡ ë§ˆì»¤(quantity=0) + í˜„ê¸ˆ/ìì‚° ì¦ê°€
- **ì¡°ì • ê±°ë˜**: realized_profit=0 (ì†ìµ ì—†ìŒ)

## ê°œë°œ ê°€ì´ë“œ

### êµ¬í˜„ ìˆœì„œ (ê¶Œì¥)
1. PostgreSQL ìŠ¤í‚¤ë§ˆ êµ¬ì¶•
2. Redis ê¸°ë³¸ êµ¬ì¡° ì„¤ì •
3. ê¸°ë³¸ ê±°ë˜ ê¸°ëŠ¥ êµ¬í˜„
4. ìˆ˜ìµ ê³„ì‚° ì‹œìŠ¤í…œ êµ¬í˜„
5. ë°°ë‹¹/ì¡°ì • íŠ¹ìˆ˜ ê±°ë˜ êµ¬í˜„

### ì£¼ìš” ê³ ë ¤ì‚¬í•­
- **ë°ì´í„° ì •í•©ì„±**: PostgreSQL íŠ¸ëœì­ì…˜ê³¼ Redis ì—…ë°ì´íŠ¸ ë™ê¸°í™”
- **ì„±ëŠ¥**: Redis ë°°ì¹˜ ì²˜ë¦¬, ì¸ë±ìŠ¤ ìµœì í™”
- **í™•ì¥ì„±**: íŒŒí‹°ì…”ë‹, ì½ê¸° ì „ìš© ë³µì œë³¸ ê³ ë ¤
- **ë³´ì•ˆ**: ë¯¼ê° ì •ë³´ ì•”í˜¸í™”, ì ‘ê·¼ ì œì–´

---

## ë²„ì „ ì •ë³´

**Current Version**: 1.0.0 (ìˆ˜ìµ ê³„ì‚° ì‹œìŠ¤í…œ í¬í•¨)  
**Last Updated**: 2025-11-01  
**Database**: PostgreSQL 15+ + Redis 7+